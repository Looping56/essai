// 1. V√©rifier si la session finale est ouverte
$stmt = $pdo->query("SELECT valeur FROM config_systeme WHERE cle = 'etat_final'");
$est_ouvert = $stmt->fetchColumn();

if ($est_ouvert == '0') {
    die("<div style='text-align:center; padding:50px; font-family:sans-serif;'>
            <h1>Acc√®s Ferm√© üîí</h1>
            <p>La p√©riode de validation finale n'est pas encore ouverte.</p>
            <a href='index.html'>Retour</a>
         </div>");
}

$membre_id = 1; // ID de test

// 2. R√©cup√©rer les choix temporaires du membre
$query = $pdo->prepare("
    SELECT p.reference, p.couleur, c.quantite, p.image_path 
    FROM commandes c 
    JOIN pieces p ON c.piece_id = p.id 
    WHERE c.membre_id = ? AND c.statut = 'temporaire'
");
$query->execute([$membre_id]);
$mes_choix = $query->fetchAll();

// 3. Traitement de la validation finale
if (isset($_POST['confirmer_tout'])) {
    $update = $pdo->prepare("UPDATE commandes SET statut = 'definitif' WHERE membre_id = ?");
    $update->execute([$membre_id]);
    echo "<script>alert('Commande valid√©e d√©finitivement !'); window.location.href='index.html';</script>";
    exit;
}


<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Validation Finale - Lego Manager</title>
    <style>
        body { font-family: sans-serif; background: #f4f7f6; padding: 20px; }
        .container { max-width: 700px; margin: auto; background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .warning { background: #fff3cd; color: #856404; padding: 15px; border-radius: 5px; margin-bottom: 20px; border: 1px solid #ffeeba; }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 12px; border-bottom: 1px solid #eee; text-align: left; }
        .btn-final { background: #e67e22; color: white; border: none; padding: 15px 25px; border-radius: 6px; cursor: pointer; font-size: 1.1em; width: 100%; margin-top: 20px; }
        @media print {
            /* Cache les boutons et les liens √† l'impression */
            .btn-final, a, .warning {
                display: none !important;
        }
        /* Optimise le tableau pour le papier */
        body { background: white; padding: 0; }
        .container { box-shadow: none; border: none; width: 100%; max-width: 100%; }
        h1 { font-size: 18pt; margin-bottom: 20px; }
        }
    </style>
</head>
<body>

<div class="container">
    <h1>R√©capitulatif de votre commande üßæ</h1>
    
    <?html if (empty($mes_choix)): ?>
        <p>Vous n'avez s√©lectionn√© aucune pi√®ce pour le moment.</p>
        <a href="choix_pieces.html">Aller au catalogue</a>
    <?html else: ?>
        <div class="warning">
            <strong>Attention :</strong> Une fois valid√©e, vous ne pourrez plus modifier votre liste de pi√®ces !
        </div>

        <table>
            <thead>
                <tr>
                    <th>Pi√®ce</th>
                    <th>Quantit√©</th>
                </tr>
            </thead>
            <tbody>
                <?html foreach ($mes_choix as $choix): ?>
                <tr>
                    <td>
                        <strong><?html echo $choix['reference']; ?></strong><br>
                        <small><?html echo $choix['couleur']; ?></small>
                    </td>
                    <td>x <?html echo $choix['quantite']; ?></td>
                </tr>
                <?html endforeach; ?>
            </tbody>
        </table>

        <form method="POST">
            <button type="submit" name="confirmer_tout" class="btn-final">Confirmer d√©finitivement ma commande ‚úÖ</button>
        </form>
    <?html endif; ?>
    
    <p style="text-align:center;"><a href="index.html">Retour √† l'accueil</a></p>
</div>

</body>

</html>
